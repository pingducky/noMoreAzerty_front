@using Microsoft.AspNetCore.Authorization
@using noMoreAzerty_front.Handlers
@using noMoreAzerty_dto.DTOs.Response
@inject VaultService VaultService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">
            Share Vault: @vaultUsersData?.VaultName
        </MudText>
    </TitleContent>

    <DialogContent>
        <!-- Formulaire d'ajout -->
        <MudCard Class="mb-4" Elevation="0" Outlined="true">
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Share with a user</MudText>

                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudTextField @bind-Value="newUserName"
                                  Label="Name"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  FullWidth
                                  Disabled="@isLoading" />

                    <MudButton OnClick="ShareVault"
                               Color="Color.Primary"
                               Variant="Variant.Filled"
                               Disabled="@(string.IsNullOrWhiteSpace(newUserName) || isLoading)"
                               StartIcon="@Icons.Material.Filled.Share">
                        Share
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>

        <!-- Liste des utilisateurs ayant accÃ¨s -->
        <MudCard Elevation="0" Outlined="true">
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Users with access</MudText>

                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else if (vaultUsersData == null || !vaultUsersData.Users.Any())
                {
                    <MudText Color="Color.Secondary" Typo="Typo.body2">
                        Only you have access to this vault
                    </MudText>
                }
                else
                {
                    <MudList T="string" Dense="true">
                        @foreach (var user in vaultUsersData.Users)
                        {
                            <MudListItem T="string">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <div>
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.body1">
                                                @user.Name
                                                @if (user.IsOwner)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">Owner</MudChip>
                                                }
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @(user.IsOwner ? "Created" : "Shared") @user.SharedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                            </MudText>
                                        </MudStack>
                                    </div>

                                    @if (!user.IsOwner)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       OnClick="@(() => RemoveUser(user))" />
                                    }
                                </MudStack>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Text">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public GetVaultResponse? Vault { get; set; }

    private VaultUsersResponse? vaultUsersData;
    private string newUserName = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        if (Vault == null) return;

        isLoading = true;
        try
        {
            vaultUsersData = await VaultService.GetVaultUsersAsync(Vault.Id);

            if (vaultUsersData == null)
            {
                Snackbar.Add("Failed to load users", Severity.Error);
            }
        }
        catch (ApiException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ShareVault()
    {
        if (Vault == null || string.IsNullOrWhiteSpace(newUserName)) return;

        isLoading = true;
        try
        {
            bool success = await VaultService.ShareVaultAsync(Vault.Id, newUserName);

            if (success)
            {
                Snackbar.Add($"Vault shared with {newUserName}", Severity.Success);
                newUserName = string.Empty;
                await LoadUsers();
            }
            else
            {
                Snackbar.Add("Failed to share vault", Severity.Error);
            }
        }
        catch (ApiException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sharing vault: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RemoveUser(VaultUserDto user)
    {
        if (Vault == null) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm deletion",
            $"Remove {user.Name} from this vault?",
            yesText: "Remove",
            cancelText: "Cancel");

        if (confirm != true) return;

        isLoading = true;
        try
        {
            bool success = await VaultService.RemoveUserFromVaultAsync(Vault.Id, user.UserId);

            if (success)
            {
                Snackbar.Add($"{user.Name} removed from vault", Severity.Success);
                await LoadUsers();
            }
            else
            {
                Snackbar.Add("Failed to remove user", Severity.Error);
            }
        }
        catch (ApiException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing user: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Close()
    {
        MudDialog.Close();
    }
}