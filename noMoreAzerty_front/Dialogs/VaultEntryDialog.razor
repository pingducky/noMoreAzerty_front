@using Microsoft.AspNetCore.Authorization
@using noMoreAzerty_front.Handlers
@using noMoreAzerty_dto.DTOs.Request;
@using noMoreAzerty_dto.DTOs.Response;
@inject VaultEntryService VaultEntryService
@inject VaultService VaultService
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudDialog MaxWidth="MaxWidth.Medium" FullWidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(IsEdit ? "Edit Entry" : "New Entry")
        </MudText>
    </TitleContent>

    <DialogContent>

        <!-- Titre -->
        <MudCard Class="mb-2" Elevation="0" Outlined="true">
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Class="mb-1">General</MudText>

                <MudTextField Variant="Variant.Outlined"
                              Label="Title"
                              Margin="Margin.Dense"
                              @bind-Value="Title"
                              Required="true"
                              FullWidth />
            </MudCardContent>
        </MudCard>

        <!-- Identifiants -->
        <MudCard Class="mb-3" Elevation="0" Outlined="true">
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Credentials</MudText>

                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <MudTextField Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Label="Username"
                                      @bind-Value="Username"
                                      FullWidth />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <div class="d-flex align-items-center">
                            <MudTextField @ref="_passwordField"
                                          Variant="Variant.Outlined"
                                          Label="Password"
                                          Value="@Password"
                                          Margin="Margin.Dense"
                                          ValueChanged="@(async (string value) => await OnPasswordInput(value))"
                                          Immediate="true"
                                          InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                                          Required="true"
                                          FullWidth
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                          OnAdornmentClick="@ToggleShowPassword" />

                            <MudIconButton Icon="@Icons.Material.Filled.Casino"
                                           OnClick="@GeneratePassword"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           Class="ml-2" />
                        </div>
                        <MudProgressLinear Value="@PasswordStrength" Color="@PasswordStrengthColor" Style="margin-top:10px;" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField Variant="Variant.Outlined"
                                      Label="URL"
                                      Margin="Margin.Dense"
                                      @bind-Value="Url"
                                      FullWidth />
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Commentaire -->
        <MudCard Class="mb-3" Elevation="0" Outlined="true">
            <MudCardContent>
                <MudText Typo="Typo.subtitle1" Class="mb-2">Notes</MudText>

                <MudTextField Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Label="Commentary"
                              @bind-Value="Commentary"
                              Lines="4"
                              FullWidth />
            </MudCardContent>
        </MudCard>
        
        <!-- Si édit, dates create / edit -->
        @if (IsEdit)
        {
            <MudCard Elevation="0" Outlined="true">
                <MudCardContent>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption">
                            Created at: @CreatedAt.ToLocalTime()
                        </MudText>

                        <MudText Typo="Typo.caption">
                            Modified: @UpdatedAt.ToLocalTime()
                        </MudText>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }

    </DialogContent>

    <DialogActions>
        <MudSpacer />
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="Save"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(!IsValid)">
            @(IsEdit ? "Update" : "Save")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Inject] IJSRuntime JS { get; set; } = default!;
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public EventCallback<GetVaultEntriesResponse> OnSave { get; set; }
    [Parameter] public GetVaultEntriesResponse? Entry { get; set; }

    private bool IsEdit { get; set; } = false;

    private string Title { get; set; } = string.Empty;
    private string Username { get; set; } = string.Empty;
    private string Password { get; set; } = string.Empty;
    private string Url { get; set; } = string.Empty;
    private string Commentary { get; set; } = string.Empty;

    private DateTime CreatedAt { get; set; }
    private DateTime UpdatedAt { get; set; }

    private bool IsValid =>
        !string.IsNullOrWhiteSpace(Title) &&
        !string.IsNullOrWhiteSpace(Password);

    private string DerivedKey { get; set; } = string.Empty;
    private string Salt { get; set; } = string.Empty;

    private double PasswordStrength { get; set; } = 0;

    private Color PasswordStrengthColor =>
        PasswordStrength < 40 ? Color.Error :
        PasswordStrength < 70 ? Color.Warning :
        Color.Success;

    private bool _showPassword = false;
    private MudTextField<string>? _passwordField;

    protected override void OnInitialized()
    {
        // Fixer le mode édition dès l'initialisation
        IsEdit = Entry != null;

        if (Entry != null)
        {
            Title = Entry.CipherTitle;
            Username = Entry.CipherUsername;
            Password = Entry.CipherPassword;
            Url = Entry.CipherUrl;
            Commentary = Entry.CipherCommentary;

            CreatedAt = Entry.CreatedAt ?? DateTime.Now;
            UpdatedAt = Entry.UpdatedAt ?? DateTime.Now;
        }
    }

    private void ToggleShowPassword()
    {
        _showPassword = !_showPassword;
    }

    private async Task GeneratePassword()
    {
        var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*";
        var random = new Random();
        var generated = new string(Enumerable.Repeat(chars, 16)
            .Select(s => s[random.Next(s.Length)]).ToArray());

        await OnPasswordInput(generated);

        // Refocus pour forcer la validation et enlever l'avertissement
        if (_passwordField != null)
            await _passwordField.FocusAsync();
    }

    private async Task OnPasswordInput(string password)
    {
        Password = password;

        if (string.IsNullOrEmpty(password))
        {
            PasswordStrength = 0;
            return;
        }

        PasswordStrength = await JS.InvokeAsync<double>(
            "getPasswordStrength",
            password
        );
    }

    private async Task Save()
    {
        if (!string.IsNullOrWhiteSpace(Title) && !string.IsNullOrWhiteSpace(Password))
        {
            // Chiffrement côté JS
            var titleResult = await JS.InvokeAsync<Dictionary<string, string>>(
                "encryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                Title
            );
            var usernameResult = await JS.InvokeAsync<Dictionary<string, string>>(
                "encryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                Username
            );
            var passwordResult = await JS.InvokeAsync<Dictionary<string, string>>(
                "encryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                Password
            );
            var urlResult = await JS.InvokeAsync<Dictionary<string, string>>(
                "encryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                Url
            );
            var commentaryResult = await JS.InvokeAsync<Dictionary<string, string>>(
                "encryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                Commentary
            );

            GetVaultEntriesResponse? vaultEntry = null;

            try
            {
                if (IsEdit)
                {
                    // Mode Update
                    var updateRequest = new UpdateVaultEntryRequest
                    {
                        CipherTitle = titleResult["ciphertext"],
                        TitleIV = titleResult["iv"],
                        TitleTag = titleResult["tag"],
                        CipherUsername = usernameResult["ciphertext"],
                        UsernameIV = usernameResult["iv"],
                        UsernameTag = usernameResult["tag"],
                        CipherPassword = passwordResult["ciphertext"],
                        PasswordIV = passwordResult["iv"],
                        PasswordTag = passwordResult["tag"],
                        CipherUrl = urlResult["ciphertext"],
                        UrlIV = urlResult["iv"],
                        UrlTag = urlResult["tag"],
                        CipherCommentary = commentaryResult["ciphertext"],
                        ComentaryIV = commentaryResult["iv"],
                        ComentaryTag = commentaryResult["tag"]
                    };

                    vaultEntry = await VaultEntryService.UpdateEntryAsync(
                        updateRequest,
                        VaultService.CurrentVault.Id,
                        Entry!.Id
                    );

                    if (vaultEntry == null)
                    {
                        Snackbar.Add("Failed to update entry", Severity.Error);
                        return;
                    }

                    Snackbar.Add("Entry updated successfully", Severity.Success);
                }
                else
                {
                    // Mode Create
                    var createRequest = new CreateVaultEntryRequest
                    {
                        CipherTitle = titleResult["ciphertext"],
                        TitleIV = titleResult["iv"],
                        TitleTag = titleResult["tag"],
                        CipherUsername = usernameResult["ciphertext"],
                        UsernameIV = usernameResult["iv"],
                        UsernameTag = usernameResult["tag"],
                        CipherPassword = passwordResult["ciphertext"],
                        PasswordIV = passwordResult["iv"],
                        PasswordTag = passwordResult["tag"],
                        CipherUrl = urlResult["ciphertext"],
                        UrlIV = urlResult["iv"],
                        UrlTag = urlResult["tag"],
                        CipherCommentary = commentaryResult["ciphertext"],
                        ComentaryIV = commentaryResult["iv"],
                        ComentaryTag = commentaryResult["tag"]
                    };

                    vaultEntry = await VaultEntryService.CreateEntryAsync(
                        createRequest,
                        VaultService.CurrentVault.Id
                    );

                    if (vaultEntry == null)
                    {
                        Snackbar.Add("Failed to create entry", Severity.Error);
                        return;
                    }

                    Snackbar.Add("Entry created successfully", Severity.Success);
                }
            }
            catch (ApiException ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
                return;
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erreur inattendue : {ex.Message}", Severity.Error);
                return;
            }

            // Déchiffrement des données pour affichage
            vaultEntry.CipherTitle = await JS.InvokeAsync<string>(
                "decryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                vaultEntry.TitleIV,
                vaultEntry.TitleTag,
                vaultEntry.CipherTitle,
                100000
            );

            vaultEntry.CipherUsername = await JS.InvokeAsync<string>(
                "decryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                vaultEntry.UsernameIV,
                vaultEntry.UsernameTag,
                vaultEntry.CipherUsername,
                100000
            );

            vaultEntry.CipherUrl = await JS.InvokeAsync<string>(
                "decryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                vaultEntry.UrlIV,
                vaultEntry.UrlTag,
                vaultEntry.CipherUrl,
                100000
            );

            vaultEntry.CipherPassword = await JS.InvokeAsync<string>(
                "decryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                vaultEntry.PasswordIV,
                vaultEntry.PasswordTag,
                vaultEntry.CipherPassword,
                100000
            );

            vaultEntry.CipherCommentary = await JS.InvokeAsync<string>(
                "decryptAesGcm",
                VaultService.Password,
                VaultService.Salt,
                vaultEntry.ComentaryIV,
                vaultEntry.ComentaryTag,
                vaultEntry.CipherCommentary,
                100000
            );

            await OnSave.InvokeAsync(vaultEntry);
            MudDialog.Close();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}