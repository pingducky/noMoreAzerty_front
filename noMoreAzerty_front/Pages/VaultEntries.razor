@page "/vaults/{vaultId:guid}"
@using Microsoft.AspNetCore.Authorization
@using noMoreAzerty_front.Dialogs
@using noMoreAzerty_front.Handlers
@inject VaultService VaultService
@inject VaultEntryService VaultEntryService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Vault Entries</PageTitle>

<MudContainer>
    <MudStack Row="true"
              AlignItems="AlignItems.Center"
              Justify="Justify.SpaceBetween"
              Class="mb-4 w-100">
        <MudText Typo="Typo.h4">
            @Vault?.Name
        </MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="OpenCreateVaultEntryDialog">
            New entry
        </MudButton>
    </MudStack>

    @if (Vault == null)
    {
        <MudText Color="Color.Secondary">Loading...</MudText>
    }
    else if (Entries == null || !Entries.Any())
    {
        <MudText Color="Color.Secondary">No entries found in this vault.</MudText>
    }
    else
    {
        <MudStack Spacing="2">
            @foreach (var entry in Entries)
            {
                <MudPaper Elevation="1"
                          @onclick="() => SelectVaultEntry(entry)"
                          Class="@($"vault-card {(SelectedEntry?.Id == entry.Id ? "selected" : "")}")">

                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.subtitle1">
                            @entry.CipherTitle
                        </MudText>

                        <MudSpacer />
                        
                        <MudIconButton Color="Color.Error"
                                       Icon="@Icons.Material.Filled.Delete"
                                       OnClick="@(e => DeleteVaultEntry(entry))"
                                       OnClick:stopPropagation="true" />

                    </MudStack>

                </MudPaper>
            }
        </MudStack>
    }
</MudContainer>

@code {
    [Inject] IJSRuntime JS { get; set; } = default!;
    [Parameter] public Guid VaultId { get; set; }
    private VaultService.Vault? Vault { get; set; }
    private List<VaultEntryService.VaultEntry> Entries { get; set; } = new List<VaultEntryService.VaultEntry>();
    private VaultEntryService.VaultEntry? SelectedEntry;

    protected override async Task OnInitializedAsync()
    {
        Vault = VaultService.CurrentVault;
        Entries = VaultEntryService.Entries;

        if (Entries != null)
        {
            foreach (var entry in Entries)
            {
                Console.WriteLine($"Decrypting title for entry ID: {entry.Id}, CipherTitle : {entry.CipherTitle}");

                entry.CipherTitle = await JS.InvokeAsync<string>(
                    "decryptAesGcm",
                    VaultService.Password,
                    VaultService.Salt,
                    entry.TitleIV,
                    entry.TitleTag,
                    entry.CipherTitle,
                    100000
                );

                entry.CipherUsername = await JS.InvokeAsync<string>(
                    "decryptAesGcm",
                    VaultService.Password,
                    VaultService.Salt,
                    entry.UsernameIV,
                    entry.UsernameTag,
                    entry.CipherUsername,
                    100000
                );

                entry.CipherUrl = await JS.InvokeAsync<string>(
                    "decryptAesGcm",
                    VaultService.Password,
                    VaultService.Salt,
                    entry.UrlIV,
                    entry.UrlTag,
                    entry.CipherUrl,
                    100000
                );

                entry.CipherPassword = await JS.InvokeAsync<string>(
                    "decryptAesGcm",
                    VaultService.Password,
                    VaultService.Salt,
                    entry.PasswordIV,
                    entry.PasswordTag,
                    entry.CipherPassword,
                    100000
                );

                entry.CipherCommentary = await JS.InvokeAsync<string>(
                    "decryptAesGcm",
                    VaultService.Password,
                    VaultService.Salt,
                    entry.ComentaryIV,
                    entry.ComentaryTag,
                    entry.CipherCommentary,
                    100000
                );
                Console.WriteLine($"Decrypted title: {entry.CipherTitle}");
            }
        }
    }

    private async Task SelectVaultEntry(VaultEntryService.VaultEntry vaultEntry)
    {
        SelectedEntry = vaultEntry;
        await OpenEditVaultEntryDialog(vaultEntry);
    }

    private async Task OpenCreateVaultEntryDialog()
    {
        var parameters = new DialogParameters
        {
            { "OnSave", EventCallback.Factory.Create<VaultEntryService.VaultEntry>(this, AddEntry) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        DialogService.Show<VaultEntryDialog>("Create Entry", parameters, options);
    }

    private async Task OpenEditVaultEntryDialog(VaultEntryService.VaultEntry entry)
    {
        var parameters = new DialogParameters
        {
            { "Entry", entry },
            { "OnSave", EventCallback.Factory.Create<VaultEntryService.VaultEntry>(this, UpdateEntry) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        DialogService.Show<VaultEntryDialog>("Edit Entry", parameters, options);
    }

    private async Task DeleteVaultEntry(VaultEntryService.VaultEntry vaultEntry)
    {

        bool? confirmed = await DialogService.ShowMessageBox(
            "Confirm deletion",
            $"Are you sure you want to delete the vault '{vaultEntry.CipherTitle}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel"
        );

        if (confirmed != true) return;

        try
        {
            var success = await VaultEntryService.DeleteEntryAsync(VaultId, vaultEntry.Id);

            if (!success)
                return;

            if (success)
            {
                Snackbar.Add("Entry deleted", Severity.Success);
                Entries.Remove(vaultEntry);
            }
        }
        catch (ApiException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur inattendue : {ex.Message}", Severity.Error);
        }
    }

    private void AddEntry(VaultEntryService.VaultEntry newVaultEntry)
    {
        Entries.Add(newVaultEntry);
    }

    private void UpdateEntry(VaultEntryService.VaultEntry updatedEntry)
    {
        var index = Entries.FindIndex(e => e.Id == updatedEntry.Id);
        if (index != -1)
            Entries[index] = updatedEntry;
    }

}