@using Microsoft.AspNetCore.Authorization
@using noMoreAzerty_front.Dialogs
@using noMoreAzerty_front.Handlers
@using noMoreAzerty_dto.DTOs.Response;
@using static noMoreAzerty_front.Services.VaultService
@inject VaultService VaultService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@page "/"
@attribute [Authorize]

<PageTitle>My Vaults</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">

    <MudStack Row="true"
              AlignItems="AlignItems.Center"
              Justify="Justify.SpaceBetween"
              Class="mb-4 w-100">
        <MudText Typo="Typo.h4">
            My Vaults
        </MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="OpenCreateVaultDialog">
            New vault
        </MudButton>
    </MudStack>

    @if (isLoading)
    {
        <MudText Color="Color.Secondary">
            Loading vaults...
        </MudText>
    }
    else
    {
        <!-- Mes coffres -->
        @if (!vaults.Any())
        {
            <MudText Color="Color.Secondary">
                No vault found!
            </MudText>
        }
        else
        {
            <MudStack Spacing="2" Class="mb-4">
                @foreach (var vault in vaults)
                {
                    <MudPaper Elevation="1"
                              Class="@($"vault-card {(selectedVault?.Id == vault.Id ? "selected" : "")}")"
                              @onclick="() => SelectVault(vault)">

                        <MudStack Row="true" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.subtitle1">
                                @vault.Name
                            </MudText>

                            <MudSpacer />

                            <MudIconButton Color="Color.Default"
                                           OnClick="@(() => OpenEditDialog(vault))"
                                           Icon="@Icons.Material.Filled.Edit"
                                           Title="Edit vault name" />

                            <MudIconButton Color="Color.Primary"
                                           OnClick="@(() => OpenShareDialog(vault))"
                                           Icon="@Icons.Material.Filled.Share"
                                           Title="Share vault" />

                            <MudIconButton Color="Color.Error"
                                           OnClick="@(() => DeleteVault(vault))"
                                           Icon="@Icons.Material.Filled.Delete"
                                           Title="Delete vault" />
                        </MudStack>

                    </MudPaper>
                }
            </MudStack>
        }

        <!-- Coffres partagés -->
        @if (sharedVaults.Any())
        {
            <MudDivider Class="my-4" />

            <MudText Typo="Typo.h5" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                Shared Vaults
            </MudText>

            <MudStack Spacing="2">
                @foreach (var vault in sharedVaults)
                {
                    <MudPaper Elevation="1"
                              Class="@($"vault-card {(selectedVault?.Id == vault.Id ? "selected" : "")}")"
                              @onclick="() => SelectVault(vault)">

                        <MudStack Row="true" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Class="mr-2" Color="Color.Info" />
                            <MudText Typo="Typo.subtitle1">
                                @vault.Name
                            </MudText>

                            <MudSpacer />

                            <!-- Pas de boutons edit/share/delete pour les vaults partagés -->
                        </MudStack>

                    </MudPaper>
                }
            </MudStack>
        }
    }
</MudContainer>


@code {
    private List<GetVaultResponse> vaults = new();
    private List<GetVaultResponse> sharedVaults = new();

    private GetVaultResponse? selectedVault;

    private bool isLoading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            // Charger mes vaults et les vaults partagés en parallèle
            var myVaultsTask = VaultService.GetAllVaultsAsync();
            var sharedVaultsTask = VaultService.GetSharedVaultsAsync();

            await Task.WhenAll(myVaultsTask, sharedVaultsTask);

            vaults = await myVaultsTask;
            sharedVaults = await sharedVaultsTask;
        }
        catch (ApiException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Unexpected error: {ex.Message}", Severity.Error);
        }

        isLoading = false;
    }

    private async Task SelectVault(GetVaultResponse vault)
    {
        selectedVault = vault;
        await OpenPasswordDialog(vault);
    }

    private void AddVault(GetVaultResponse newVault)
    {
        vaults.Add(newVault);
    }

    private void UpdateVault(GetVaultResponse updatedVault)
    {
        var index = vaults.FindIndex(v => v.Id == updatedVault.Id);
        if (index != -1)
        {
            vaults[index] = updatedVault;
            StateHasChanged();
        }
    }

    private async void DeleteVault(GetVaultResponse vault)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm deletion",
            $"Are you sure you want to delete the vault '{vault.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel"
        );

        if (confirm != true) return;

        bool success = await VaultService.DeleteVaultAsync(vault.Id);

        if (success)
        {
            vaults.Remove(vault);
            Snackbar.Add($"Vault '{vault.Name}' deleted successfully", Severity.Success);
            StateHasChanged();
        }
        else
        {
            Snackbar.Add("Failed to delete vault", Severity.Error);
        }
    }

    private async Task OpenCreateVaultDialog()
    {
        var parameters = new DialogParameters
        {
            { "OnSave", EventCallback.Factory.Create<GetVaultResponse>(this, AddVault) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        await DialogService.ShowAsync<CreateVaultDialog>("Create Vault", parameters, options);
    }

    private async Task OpenEditDialog(GetVaultResponse vault)
    {
        var parameters = new DialogParameters
        {
            { "Vault", vault },
            { "OnSave", EventCallback.Factory.Create<GetVaultResponse>(this, UpdateVault) }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        await DialogService.ShowAsync<EditVaultDialog>("Edit Vault", parameters, options);
    }

    private async Task OpenPasswordDialog(GetVaultResponse vault)
    {
        var parameters = new DialogParameters
        {
            { "Vault", vault }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        await DialogService.ShowAsync<PasswordDialog>("Enter Password", parameters, options);
    }

    private async Task OpenShareDialog(GetVaultResponse vault)
    {
        var parameters = new DialogParameters
        {
            { "Vault", vault }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<ShareVaultDialog>("Share Vault", parameters, options);
    }
}