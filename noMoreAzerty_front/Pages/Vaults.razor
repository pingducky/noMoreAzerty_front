@using Microsoft.AspNetCore.Authorization
@using noMoreAzerty_front.Handlers
@using static noMoreAzerty_front.Services.VaultService
@inject VaultService VaultService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@page "/"
@attribute [Authorize]

<PageTitle>My Vaults</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">

    <MudStack Row="true"
              AlignItems="AlignItems.Center"
              Justify="Justify.SpaceBetween"
              Class="mb-4 w-100">
        <MudText Typo="Typo.h4">
            My Vaults
        </MudText>
        <MudButton StartIcon="@Icons.Material.Filled.Add"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="OpenCreateVaultDialog">
            New vault
        </MudButton>
    </MudStack>

    @if (isLoading)
    {
        <MudText Color="Color.Secondary">
            Loading vaults...
        </MudText>
    }
    else if (!vaults.Any())
    {
        <MudText Color="Color.Secondary">
            No vault find !
        </MudText>
    }
    else
    {
        <MudStack Spacing="2">
            @foreach (var vault in vaults)
            {
                <MudPaper Elevation="1"
                          Class="@($"vault-card {(selectedVault?.Id == vault.Id ? "selected" : "")}")"
                          @onclick="() => SelectVault(vault)">

                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.subtitle1">
                            @vault.Name
                        </MudText>

                        <MudSpacer />

                        <MudIconButton Color="Color.Error"
                                       OnClick="@(e => DeleteVault(vault))"
                                       Icon="@Icons.Material.Filled.Delete" />
                    </MudStack>

                </MudPaper>
            }
        </MudStack>
    }
</MudContainer>


@code {
    private List<VaultService.Vault> vaults = new();

    private VaultService.Vault? selectedVault;

    private bool isLoading { get; set; }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            vaults = await VaultService.GetAllVaultsAsync();
        }
        catch (ApiException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur inattendue : {ex.Message}", Severity.Error);
        }

        isLoading = false;
    }

    private async Task SelectVault(VaultService.Vault vault)
    {
        selectedVault = vault;
        await OpenPasswordDialog(vault);
    }

    private void AddVault(VaultService.Vault newVault)
    {
        vaults.Add(newVault);
    }

    private void DeleteVault(VaultService.Vault vault)
    {
        vaults.Remove(vault);
    }

    private async Task OpenCreateVaultDialog()
    {
        var parameters = new DialogParameters
        {
            { "OnSave", EventCallback.Factory.Create<VaultService.Vault>(this, AddVault) }
        };
    
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
    
        DialogService.Show<CreateVaultDialog>("Create Vault", parameters, options);
    }

    private async Task OpenPasswordDialog(VaultService.Vault vault)
    {
        var parameters = new DialogParameters
        {
            { "Vault", vault }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

        DialogService.Show<PasswordDialog>("Enter Password", parameters, options);
    }
}